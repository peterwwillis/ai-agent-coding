# Dockerfile.devbox
# AI coding devbox image: Ubuntu + toolchains + common CLIs
# Playwright browsers and Android emulator are provided as separate services

FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive \
    TZ=Etc/UTC

# ---- Base dev tools (C/C++/build), networking, convenience ----
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates curl wget git git-lfs openssh-client gnupg lsb-release \
    build-essential clang cmake ninja-build pkg-config \
    gdb lldb strace \
    unzip zip xz-utils \
    jq yq ripgrep fd-find fzf \
    tmux vim nano \
    python3 python3-pip python3-venv \
    docker.io docker-compose \
    sqlite3 \
    eza \
    direnv \
  && rm -rf /var/lib/apt/lists/*

# ---- mise (installed from its apt repo) ----
# Official apt-based install steps. :contentReference[oaicite:6]{index=6}
RUN apt-get update && apt-get install -y --no-install-recommends \
    sudo \
  && rm -rf /var/lib/apt/lists/*

RUN install -dm 755 /etc/apt/keyrings \
  && curl -fSs https://mise.jdx.dev/gpg-key.pub | tee /etc/apt/keyrings/mise-archive-keyring.asc >/dev/null \
  && echo "deb [signed-by=/etc/apt/keyrings/mise-archive-keyring.asc] https://mise.jdx.dev/deb stable main" \
      | tee /etc/apt/sources.list.d/mise.list >/dev/null \
  && apt-get update \
  && apt-get install -y --no-install-recommends mise \
  && rm -rf /var/lib/apt/lists/*

# Ensure mise shims are on PATH for non-interactive shells
ENV PATH="/root/.local/share/mise/shims:/root/.local/bin:${PATH}"

# Install language runtimes via mise.
# Note: Copilot CLI requires Node.js 22+ for npm install path. :contentReference[oaicite:7]{index=7}
RUN mise install -y node@22 python@3.12 java@temurin-21 \
  && mise use -g node@22 python@3.12 java@temurin-21

# ---- Playwright browser path (browsers provided via pw service) ----
ENV PLAYWRIGHT_BROWSERS_PATH=/ms-playwright

# ---- AI coding CLIs (installed via npm global) ----
# Codex CLI install: npm i -g @openai/codex :contentReference[oaicite:9]{index=9}
# Copilot CLI install: npm install -g @github/copilot :contentReference[oaicite:10]{index=10}
# Gemini CLI npm package exists; install via npm. :contentReference[oaicite:11]{index=11}
# Claude Code: npm method exists but is deprecated in favor of native installer. :contentReference[oaicite:12]{index=12}
RUN npm i -g \
    @openai/codex \
    @github/copilot \
    @google/gemini-cli \
    @anthropic-ai/claude-code

# ---- Llama.cpp (build toolchain already present); you will build per-project as needed ----
# (Intentionally not cloning/building here to avoid pinning a moving target.)

WORKDIR /workspace
CMD ["/bin/bash"]
